## README

### Описание проекта

Это демонстрационный проект REST API банка, созданный с использованием Spring Boot версии 3.3.13. Проект предназначен для демонстрации возможностей фреймворка Spring Boot в разработке веб-приложений и реализации RESTful сервисов.

---

### Стек технологий

Проект построен с использованием следующих технологий и библиотек:

#### Основные зависимости:

- **Spring Boot Starter Data JPA**: ORM-инструменты для взаимодействия с базой данных.
- **Spring Boot Starter Data Redis**: Поддержка интеграции с Redis для хранения refresh токенов.
- **Lettuce Core**: Клиентская библиотека для работы с Redis.
- **Spring Boot Starter Security**: Библиотека безопасности для аутентификации и авторизации пользователей.
- **Spring Boot Starter Validation**: Инструменты для проверки валидности входных данных.
- **Spring Boot Starter Web**: Базовая поддержка разработки веб-сервисов.
- **Liquibase Core**: Инструмент миграции базы данных.
- **Springdoc OpenAPI Starter Web MVC UI**: Генерация документации API в формате Swagger.
- **JJWT**: Библиотеки для работы с JSON Web Tokens.
- **Jasypt Spring Boot Starter**: Инструменты шифрования конфигурационных свойств.
- **MapStruct**: Библиотека для автоматического мапинга объектов.
- **PostgreSQL Driver**: Драйвер для подключения к PostgreSQL.
- **Lombok**: Аннотации для упрощения написания Java-кода.
- **WireMock Standalone**: Инструменты для мокирования HTTP-запросов.
- **TestContainers**: Контейнеры для тестирования интеграций с базами данных.
- **JUnit Jupiter**: Фреймворк для модульного тестирования.
- **Jacoco Maven Plugin**: Плагин для измерения покрытия тестами.
---

## Безопасность и Архитектура Приложения

**Безопасность**

Приложение надежно защищено посредством сочетания мощнейших инструментов:

- **Spring Security + JWT:** Обеспечивает многоуровневую защиту путем управления доступом на основе ролей (`Role_User`, `Role_Admin`) и предоставления временного безопасного доступа с помощью токенов JWT.
- **Ролевая защита:** Разделение прав доступа на уровне ролей гарантирует, что пользователи получают доступ исключительно к разрешенным ресурсам.
- **Хранение учетных записей:** Все зарегистрированные пользователи сохраняются в надежной базе данных, обеспечивая сохранность персональных данных.

**Регистрация и Аутентификация**

Процесс входа прост и интуитивен:

- **Логин по номеру телефона и паролю:** Проверка подлинности производится сопоставлением введенных данных с сохраненными в базе.
- **JWT-токены:** После успешной аутентификации создается уникальный токен JWT, обеспечивающий безопасный доступ ко всем службам системы.

**Механизм Аутентификации**

Работа с аутентификацией реализована через специализированный фильтр:

- **JwtAuthenticationFilter:** Отвечает за проверку валидности токена, восстановление контекста безопасности и заполнение деталей пользователя.

**Архитектура**

Основные компоненты взаимодействуют следующим образом:

- **UserService:** Осуществляет обработку операций над пользователями и банковскими картами, включая регистрацию, аутентификацию, создание, активацию и блокировку карт, а также выполнение переводов.
- **CardService:** Управляет всеми операциями с картами, обеспечивая надежную работу сервиса.
- **CardTransferService:** Переводы между картами осуществляются асинхронно, ускоряя процессы и улучшая производительность.

**Оптимизация Производительности**

Для повышения производительности запросы к базе данных были специально оптимизированы:

- **@Transactional(readOnly = true):** Чтение данных выполняется в режиме "только чтение", минимизируя нагрузку на базу данных.
- **JPA Projections & Modifying Queries:** Используются специализированные механизмы оптимизации запросов Hibernate для уменьшения нагрузки на сервер базы данных.

**Шифрование Карточных Данные**

Номер банковской карты зашифрован с использованием специального алгоритма шифрования:

- **Hash-код карты:** Расчет уникального хэша перед шифрованием обеспечивает дополнительную безопасность карточных данных.
- **StringEncryptor:** Надежный механизм шифрования, гарантирующий конфиденциальность личной информации клиентов.

**Логирование**

Все важные события и ошибки регистрируются с применением аспектно-ориентированного программирования (AOP):

- **Контроллер и сервисы:** Отдельные аспекты позволяют отслеживать все входящие запросы и внутренние транзакции, повышая прозрачность процессов и облегчая диагностику проблем.

Таким образом, данная архитектура сочетает высокую надежность, производительность и удобство эксплуатации, делая систему безопасной и удобной для пользователей.

## Структура проекта

Ниже представлена структура проекта с описанием каждого пакета и файла:

```
.mvn/
src/
├── main/
│   └── java/
│       └── com.example.bankcards/
│           ├── aop/
│           │   ├── LogController.java
│           │   ├── LogService.java
│           │   ├── LoggableController.java
│           │   └── LoggableService.java
│           ├── config/
│           │   ├── cache/
│           │   │   └── CacheConfig.java
│           │   ├── security/
│           │   │   └── SecurityConfig.java
│           │   └── AppConfig.java
│           ├── controller/
│           │   ├── AuthorizationController.java
│           │   ├── CardController.java
│           │   └── UserController.java
│           ├── dto/
│           │   ├── request/
│           │   └── response/
│           ├── exception/
│           │   ├── CheckPasswordException.java
│           │   ├── EntityNotFoundException.java
│           │   ├── GlobalExceptionHandler.java
│           │   ├── OwnerCardException.java
│           │   ├── RefreshTokenException.java
│           │   ├── TokenParseException.java
│           │   ├── TransferException.java
│           │   └── isActiveRequestException.java
│           ├── mapper/
│           │   └── UserMapper.java
│           ├── model/
│           │   ├── jwt/
│           │   │   └── RefreshToken.java
│           │   ├── Card.java
│           │   ├── CardTransfer.java
│           │   ├── PaymentSystem.java
│           │   ├── Role.java
│           │   ├── RoleType.java
│           │   ├── StatusTransfer.java
│           │   └── User.java
│           ├── repository/
│           │   ├── projections/
│           │   ├── CardRepository.java
│           │   ├── CardTransferRepository.java
│           │   ├── RefreshTokenRepository.java
│           │   ├── RoleRepository.java
│           │   └── UserRepository.java
│           ├── security/
│           │   ├── AppUserPrincipal.java
│           │   ├── AuthenticatedDetails.java
│           │   ├── AuthenticatedUserDetails.java
│           │   └── JwtAuthenticationFilter.java
│           ├── service/
│           │   ├── security/
│           │   ├── CardService.java
│           │   ├── CardTransferService.java
│           │   └── UserService.java
│           ├── util/
│           │   ├── SecurityUtils.java
│           │   ├── StringCreatorUtils.java
│           │   └── StringUtilsMessage.java
│           └── BankRestApplication.java
│   
├── resources/
│   ├── db/
│   │   ├── changelog/
│   │   │   ├── changeset/
│   │   │   │   ├── init-db.sql
│   │   │   │   └── set-1.sql
│   │   │   └── db.changelog-master.yaml
│   ├── static/
│   │   └── docs/
│   │       └── openapi.yaml
│   └── application.yml
└── test/
    ├── java/
    │   └── com.example.bankcards/
    │       ├── controller/
    │       │   ├── AuthorizationControllerTest.java
    │       │   ├── CardControllerTest.java
    │       │   └── UserControllerTest.java
    │       ├── AbstractTest.java
    │       └── PostgresTestContainerInitializer.java
    └── resources/
        └── application-test.yml
```

### Пакеты и файлы

- **`.mvn/`**: Конфигурационные файлы для Maven Wrapper.
- **`src/main/java/com.example.bankcards/`**: Основной пакет приложения.
    - **`aop/`**: Аспекты для логгирования контроллеров и сервисов.
    - **`config/`**: Конфигурационные классы приложения.
        - **`cache/`**: Настройки кеша.
        - **`security/`**: Настройки безопасности.
    - **`controller/`**: Контроллеры для обработки запросов.
    - **`dto/`**: Объекты передачи данных между слоями.
        - **`request/`**: DTO для входящих запросов.
        - **`response/`**: DTO для исходящих ответов.
    - **`exception/`**: Пользовательские исключения и обработчики исключений.
    - **`mapper/`**: Маперы для преобразования сущностей в DTO.
    - **`model/`**: Доменные модели и сущности.
        - **`jwt/`**: Класс токенов JWT.
    - **`repository/`**: Репозитории для доступа к данным.
        - **`projections/`**: Проекции для выборки данных.
    - **`security/`**: Компоненты безопасности.
    - **`service/`**: Сервисы для бизнес-логики.
    - **`util/`**: Утилиты и вспомогательные классы.
    - **`BankRestApplication.java`**: Главный класс приложения.
- **`src/main/resources/`**: Ресурсные файлы.
    - **`db/`**: Скрипты миграций базы данных.
        - **`changelog/`**: Директория с SQL-файлами изменений.
            - **`changeset/`**: Набор скриптов инициализации и обновления БД.
    - **`static/docs/`**: Документирование API.
        - **`openapi.yaml`**: Спецификация OpenAPI.
    - **`application.yml`**: Основная конфигурация приложения.
- **`src/test/java/com.example.bankcards/`**: Тестовые классы.
    - **`controller/`**: Интеграционные тесты контроллеров.
    - **`AbstractTest.java`**: Абстрактный класс для тестов.
    - **`PostgresTestContainerInitializer.java`**: Инициализатор контейнера PostgreSQL для тестов.
- **`src/test/resources/`**: Тестовые ресурсы.
    - **`application-test.yml`**: Конфигурация для тестов.

Эта структура позволяет организовать код таким образом, чтобы легко поддерживать и расширять проект.

### Настройка и запуск

Для запуска приложения выполните следующие шаги:

1. Убедитесь, что у вас установлены Java 17 и Maven.
2. Клонируйте репозиторий и перейдите в директорию проекта.
3. Включите докер и в директории проекта выполните команду docker compose up, для установки PostgreSQL и Redis с volume
3. После этого запустите приложение

---

### Документация API

Документацию API можно просмотреть в браузере по адресу:
```
http://localhost:8090/swagger-ui.html
```

---

### Тестирование

Тесты выполняются автоматически при сборке проекта. Для ручного запуска тестов используйте команду:
```bash
mvn clean verify
```

Покрытие тестами измеряется с помощью Jacoco и отображается в отчете:
```
target/site/jacoco/index.html
```
---

### Авторство

Автор проекта — [iMynthon]

---
